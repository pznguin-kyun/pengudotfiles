#!/usr/bin/env bash

color_dir="$HOME/.config/bspwm/color"
rofi_command="rofi -dmenu -p Colors"

# List colorschemes
options=()
for file in "$color_dir"/*; do
	options+=("$(basename "$file")")
done

# Show the rofi selection menu and store the result in a variable.
color=$(printf "%s\n" "${options[@]}" | $rofi_command)

# If a valid option was selected, write the value to config files
[[ -n "$color" ]] || exit 0
[[ -d "$HOME"/.config/bspwm/color/"$color" ]] || exit 0

source "$HOME"/.config/bspwm/color/"$color"/"$color".sh

generate_fehbg(){
  echo -e "#!/usr/bin/env sh\nfeh --no-fehbg --bg-fill --randomize $HOME/.config/bspwm/color/$color/wall/" > "$HOME"/.fehbg
  chmod 777 "$HOME"/.fehbg
}

term_col(){
    echo "import = [ '~/.config/alacritty/colors/$color.toml' ]" > "$HOME"/.config/alacritty/colors.toml
}

ui_col(){
  # BSPWM
  sed -i -e "s/bspc config normal_border_color .*/bspc config normal_border_color \"$br\"/g"\
         -e "s/bspc config focused_border_color .*/bspc config focused_border_color \"$br2\"/g" "$HOME"/.config/bspwm/config/decoration
  # Polybar
  sed -i -e "s/background = .*/background = $bg/g"\
         -e "s/foreground = .*/foreground = $fg/g"\
         -e "s/accent = .*/accent = $br2/g"\
         -e "s/alert = .*/alert = $r/g" "$HOME"/.config/polybar/colors.ini
  # Rofi
  sed -i -e "s/background: .*/background: $bg;/g"\
         -e "s/foreground: .*/foreground: $fg;/g" \
         -e "s/foreground-alt: .*/foreground-alt: $br2;/g" "$HOME"/.config/rofi/colors.rasi
  # Dunst
  sed -i -e "s/background = .*/background = \"$bg\"/g"\
         -e "s/foreground = .*/foreground = \"$fg\"/g" "$HOME"/.config/dunst/dunstrc
  # GTK
  sed -i -e "s/gtk-theme-name=.*/gtk-theme-name=$color/" "$HOME"/.config/gtk-3.0/settings.ini
  # sth
  sed -i -e "s/color=.*/color="$color"/g" "$HOME"/.config/bspwm/.color
}

restart(){
    bspc wm -r
    pkill -USR1 -x sxhkd
    sleep 1
    notify-send "ðŸŽ¨ Applied colorscheme" "Color: $color"

}

# Main
generate_fehbg
term_col
ui_col
dunst
restart

exit 0
